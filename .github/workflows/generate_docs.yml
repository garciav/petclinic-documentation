name: AI Documentation Engine

on:
  repository_dispatch:
    types: [code_updated]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
      
    steps:
      - name: Checkout Docs Repo
        uses: actions/checkout@v4
        with:
          path: docs-repo

      - name: Checkout Microservice Repo
        uses: actions/checkout@v4
        with:
          repository: garciav/spring-petclinic
          token: ${{ secrets.PAT_FOR_DOCS }}
          path: source-code

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: docs-repo/package-lock.json

      # 4. Instalación del CLI
      - name: Install Copilot CLI
        run: |
          npm install -g @github/copilot
          # Esto nos dirá si el token está presente (debería imprimir '81' o similar, no el token)
          echo "Longitud del token: ${#COPILOT_GITHUB_TOKEN}"

      # 5. GENERACIÓN DE CONTENIDO CON DIAGRAMAS MERMAID
      - name: Generate AI Content
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.PAT_FOR_DOCS }}
          GH_TOKEN: ${{ secrets.PAT_FOR_DOCS }}
        run: |
          mkdir -p ./docs-repo/docs
          
          echo "Generando arquitectura con diagrama de flujo..."
          # Pedimos un diagrama de arquitectura C4 o Flowchart
          copilot -p "Analiza ./source-code. Genera arquitectura.md con Frontmatter (id: arquitectura). Incluye un diagrama Mermaid tipo 'graph TD' que muestre la relación entre Controllers, Services y Repositories. Explica el flujo de datos. Responde solo con Markdown puro compatible con Docusaurus 3." > ./docs-repo/docs/arquitectura.md
      
          echo "Generando referencia de API con Diagramas de Secuencia..."
          # Pedimos diagramas de secuencia para los endpoints más importantes
          copilot -p "Analiza ./source-code/src/main/java. Genera api.md con Frontmatter (id: api). Para cada controlador principal, incluye un diagrama Mermaid de tipo 'sequenceDiagram' que ilustre el camino de una petición HTTP desde el Controller hasta la DB. Usa backticks para variables. Responde solo con Markdown puro." > ./docs-repo/docs/api.md

          # --- LIMPIEZA SEGURA PARA MDX ---
          # Solo escapamos llaves si NO están dentro de bloques de código (donde vive Mermaid)
          # Usamos un comando de Python rápido para no romper los diagramas Mermaid
          python3 -c "
          import os, re
          for f in ['./docs-repo/docs/arquitectura.md', './docs-repo/docs/api.md']:
              if os.path.exists(f):
                  with open(f, 'r') as file:
                      content = file.read()
                  # Esta regex protege los bloques de código y escapa llaves solo en el texto
                  # (Simpliación para evitar ReferenceErrors en MDX)
                  clean = re.sub(r'(?<!`){(?!`)', '\{', content)
                  clean = re.sub(r'(?<!`)}', '\}', clean)
                  with open(f, 'w') as file:
                      file.write(clean)
          "
          
      # 6. Guardar los archivos generados
      - name: Commit and Push AI Docs
        run: |
          cd docs-repo
          git config user.name "GitHub Action Bot"
          git config user.email "actions@github.com"
          git add docs/*.md
          if ! git diff --cached --quiet; then
            git commit -m "docs: auto-update by Copilot"
            git push
          else
            echo "Sin cambios detectados."
          fi

      # 7. Construcción y Despliegue
      - name: Build Docusaurus
        run: |
          cd docs-repo
          npm install
          npm run build

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs-repo/build
